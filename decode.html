<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºŒç»´ç è§£ç å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root {
            --primary-color: #ff9000;
            --text-color: #ffffff;
            --text-gray: #cccccc;
            --border-color: #333333;
            --background-color: #000000;
            --container-bg: #1b1b1b;
            --error-color: #ff4444;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            background-color: var(--background-color);
            min-height: 100vh;
        }

        .logo {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding: 10px;
            background-color: var(--container-bg);
        }

        .logo span {
            font-size: 32px;
            font-weight: 800;
            text-transform: uppercase;
        }

        .logo span:first-child {
            color: var(--text-color);
            background: var(--container-bg);
            padding: 5px 10px;
        }

        .logo span:last-child {
            color: var(--background-color);
            background: var(--primary-color);
            padding: 5px 10px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--container-bg);
            padding: 0;
            border-radius: 0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .content-area {
            padding: 30px;
        }

        .section-title {
            color: var(--text-color);
            margin: 0 0 20px 0;
            font-size: 20px;
            font-weight: bold;
            text-transform: uppercase;
            padding: 8px 15px;
            background-color: var(--container-bg);
            border-left: 5px solid var(--primary-color);
        }

        .upload-container {
            border: 2px dashed var(--primary-color);
            border-radius: 0;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background-color: rgba(27, 27, 27, 0.8);
            position: relative;
        }

        .upload-container::before {
            content: "æ‹–æ”¾æˆ–ç‚¹å‡»ä¸Šä¼ äºŒç»´ç å›¾ç‰‡";
            display: block;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .upload-container::after {
            content: "æ”¯æŒå¤šå›¾ç‰‡ä¸Šä¼ ";
            display: block;
            font-size: 16px;
            color: var(--text-gray);
            margin-top: 10px;
        }

        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .preview-item {
            position: relative;
            background-color: rgba(27, 27, 27, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 0;
            padding: 15px;
            text-align: center;
            transition: transform 0.3s;
        }

        .preview-item:hover {
            transform: translateY(-5px);
        }

        .preview-item img {
            width: 100%;
            height: auto;
            border-radius: 0;
            margin-bottom: 10px;
        }

        .preview-item .status {
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-gray);
            padding: 5px;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .preview-item .status.success {
            color: var(--primary-color);
        }

        .preview-item .status.error {
            color: var(--error-color);
        }

        #result {
            margin: 30px 0;
            padding: 20px;
            background-color: rgba(27, 27, 27, 0.8);
            border: none;
            white-space: pre-wrap;
            word-break: break-word;
            color: var(--text-color);
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
            position: relative;
        }

        #result::before {
            content: "è§£ç ç»“æœ";
            position: absolute;
            top: -30px;
            left: 0;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 18px;
            text-transform: uppercase;
        }

        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.3);
        }

        .action-button {
            display: inline-block;
            min-width: 150px;
            padding: 12px 30px;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            border: none;
            border-radius: 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        #decodeButton {
            background-color: var(--primary-color);
            color: var(--background-color);
        }

        #decodeButton:hover {
            background-color: #fff;
            color: var(--background-color);
        }

        #resetButton {
            background-color: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        #resetButton:hover {
            background-color: var(--primary-color);
            color: var(--background-color);
        }

        .top-bar {
            background-color: var(--background-color);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 5px solid var(--primary-color);
        }

        .category-tag {
            display: inline-block;
            padding: 5px 10px;
            background-color: var(--primary-color);
            color: var(--background-color);
            font-weight: bold;
            font-size: 14px;
            margin-right: 10px;
            text-transform: uppercase;
        }

        .views-count {
            color: var(--text-gray);
            font-size: 14px;
        }

        .views-count::before {
            content: "ğŸ‘ ";
            margin-right: 5px;
        }

        .error-message {
            color: var(--error-color);
            text-align: center;
            margin: 10px 0;
            padding: 15px;
            background-color: rgba(255, 68, 68, 0.1);
            border-left: 4px solid var(--error-color);
        }

        .or-divider {
            text-align: center;
            margin: 30px 0;
            position: relative;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 18px;
        }

        .or-divider::before,
        .or-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: calc(50% - 30px);
            height: 1px;
            background-color: var(--border-color);
        }

        .or-divider::before {
            left: 0;
        }

        .or-divider::after {
            right: 0;
        }

        .input-group {
            margin: 20px 0;
            padding: 20px;
            background-color: rgba(27, 27, 27, 0.8);
            border-left: 4px solid var(--primary-color);
        }

        .input-group label {
            color: var(--primary-color);
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 16px;
        }

        .input-group textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            resize: vertical;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
            transition: border-color 0.3s;
        }

        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .input-group textarea::placeholder {
            color: var(--text-gray);
        }

        .info {
            margin-top: 30px;
            padding: 20px;
            background-color: rgba(27, 27, 27, 0.8);
            border-left: 4px solid var(--primary-color);
        }

        .info p {
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .info ol {
            color: var(--text-gray);
            margin-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <div class="logo">
                <span>QR</span><span>hub</span>
            </div>
            <div>
                <span class="category-tag">è§£ç å™¨</span>
                <span class="views-count">1337 views</span>
            </div>
        </div>

        <div class="content-area">
            <div class="section-title">äºŒç»´ç è§£ç </div>
            
            <div class="upload-container" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFile(event)" multiple>
                <div class="preview-container" id="previewContainer"></div>
                <div id="loading" style="display: none; color: var(--text-gray); margin-top: 10px;">æ­£åœ¨è§£æäºŒç»´ç ...</div>
            </div>

            <div class="or-divider">æˆ–è€…</div>

            <div class="input-group">
                <label for="qr-text">ç›´æ¥è¾“å…¥äºŒç»´ç å†…å®¹ï¼š</label>
                <textarea id="qr-text" placeholder="åœ¨è¿™é‡Œç²˜è´´äºŒç»´ç æ‰«æå¾—åˆ°çš„æ–‡æœ¬å†…å®¹"></textarea>
            </div>

            <div class="button-container">
                <button id="decodeButton" class="action-button" onclick="decodeQR()">è§£ç </button>
                <button id="resetButton" class="action-button" onclick="resetSegments()">é‡ç½®</button>
            </div>

            <div id="result"></div>
            <div id="error"></div>

            <div class="info">
                <p>ğŸ“ ä½¿ç”¨è¯´æ˜ï¼š</p>
                <ol>
                    <li>å¯ä»¥ç›´æ¥æ‹–æ”¾æˆ–ç‚¹å‡»ä¸Šä¼ å¤šä¸ªäºŒç»´ç å›¾ç‰‡</li>
                    <li>æˆ–è€…å°†äºŒç»´ç æ–‡æœ¬å†…å®¹ç²˜è´´åˆ°è¾“å…¥æ¡†</li>
                    <li>ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†å¤šä¸ªäºŒç»´ç çš„é¡ºåº</li>
                    <li>è§£ç å®Œæˆåä¼šæ˜¾ç¤ºå®Œæ•´å†…å®¹</li>
                    <li>å¦‚éœ€é‡æ–°å¼€å§‹ï¼Œè¯·ç‚¹å‡»"é‡ç½®"æŒ‰é’®</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨åˆ†æ®µæ•°æ®
        let segmentsData = null;
        let expectedTotal = 0;
        let processedImages = new Set();

        // æ‹–æ”¾å¤„ç†
        const dropZone = document.getElementById('dropZone');
        const previewContainer = document.getElementById('previewContainer');
        const loading = document.getElementById('loading');

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('highlight');
        }

        function unhighlight(e) {
            dropZone.classList.remove('highlight');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFile(event) {
            handleFiles(event.target.files);
        }

        function createPreviewItem(file) {
            const div = document.createElement('div');
            div.className = 'preview-item';
            
            const img = document.createElement('img');
            const status = document.createElement('div');
            status.className = 'status';
            status.textContent = 'ç­‰å¾…è§£ç ...';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove';
            removeBtn.textContent = 'Ã—';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                div.remove();
            };

            div.appendChild(img);
            div.appendChild(status);
            div.appendChild(removeBtn);
            previewContainer.appendChild(div);

            return { div, img, status };
        }

        function handleFiles(files) {
            if (!files || files.length === 0) return;
            
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = '';
            
            Array.from(files).forEach((file, index) => {
                const previewItem = createPreviewItem(file);
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const decodedText = await decodeImage(e.target.result, previewItem.status);
                        if (decodedText) {
                            try {
                                const version = decodedText.substring(0, 2);
                                if (version === 'v3') {
                                    const currentSegment = parseInt(decodedText.substring(2, 4));
                                    const totalSegments = parseInt(decodedText.substring(4, 6));
                                    const segmentData = decodedText.substring(6);

                                    if (!segmentsData || expectedTotal !== totalSegments) {
                                        segmentsData = new Array(totalSegments).fill(null);
                                        expectedTotal = totalSegments;
                                    }

                                    segmentsData[currentSegment - 1] = segmentData;
                                    previewItem.status.textContent = `è§£ç æˆåŠŸ (${currentSegment}/${totalSegments})`;
                                    previewItem.status.className = 'status success';
                                    updateResult();
                                } else {
                                    // éåˆ†æ®µäºŒç»´ç ï¼Œç›´æ¥æ˜¾ç¤ºç»“æœ
                                    previewItem.status.textContent = 'è§£ç æˆåŠŸ';
                                    previewItem.status.className = 'status success';
                                    
                                    // æ£€æŸ¥æ˜¯å¦æ˜¯å‹ç¼©æ ¼å¼
                                    try {
                                        const decompressedText = LZString.decompressFromEncodedURIComponent(decodedText);
                                        if (decompressedText) {
                                            // æ˜¯å‹ç¼©æ ¼å¼ï¼Œæ·»åŠ v2å‰ç¼€å¹¶ä¿å­˜åŸå§‹å‹ç¼©æ•°æ®
                                            document.getElementById('qr-text').value = 'v2' + decodedText;
                                            document.getElementById('result').textContent = decompressedText;
                                        } else {
                                            // ä¸æ˜¯å‹ç¼©æ ¼å¼ï¼Œæ˜¾ç¤ºåŸæ–‡
                                            document.getElementById('qr-text').value = decodedText;
                                            document.getElementById('result').textContent = decodedText;
                                        }
                                    } catch (error) {
                                        // è§£å‹å¤±è´¥ï¼Œæ˜¾ç¤ºåŸæ–‡
                                        document.getElementById('qr-text').value = decodedText;
                                        document.getElementById('result').textContent = decodedText;
                                    }
                                    document.getElementById('result').style.display = 'block';
                                }
                            } catch (error) {
                                console.error('è§£ç å¤„ç†é”™è¯¯:', error);
                                previewItem.status.textContent = 'è§£ç å¤„ç†å¤±è´¥';
                                previewItem.status.className = 'status error';
                            }
                        }
                    } catch (error) {
                        console.error('è§£ç å¤±è´¥:', error);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        function decodeImage(dataUrl, statusElement) {
            return new Promise((resolve, reject) => {
                const image = new Image();
                image.onload = function() {
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = image.width;
                    canvas.height = image.height;
                    context.drawImage(image, 0, 0);
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        statusElement.textContent = 'è§£ç æˆåŠŸ';
                        statusElement.className = 'status success';
                        resolve(code.data);
                    } else {
                        statusElement.textContent = 'æœªèƒ½è¯†åˆ«äºŒç»´ç ';
                        statusElement.className = 'status error';
                        reject('æœªèƒ½è¯†åˆ«äºŒç»´ç ');
                    }
                };
                image.onerror = function() {
                    statusElement.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                    statusElement.className = 'status error';
                    reject('å›¾ç‰‡åŠ è½½å¤±è´¥');
                };
                image.src = dataUrl;
            });
        }

        function updateResult() {
            if (!segmentsData) return;

            const missingSegments = segmentsData
                .map((seg, i) => seg === null ? i + 1 : null)
                .filter(x => x !== null);

            if (missingSegments.length === 0) {
                // æ‰€æœ‰åˆ†æ®µéƒ½å·²æ”¶é›†ï¼Œè¿›è¡Œè§£ç 
                const fullData = segmentsData.join('');
                try {
                    const decodedText = LZString.decompressFromEncodedURIComponent(fullData);
                    document.getElementById('result').textContent = decodedText;
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('qr-text').value = fullData;
                    // è§£ç æˆåŠŸåæ¸…ç†æ•°æ®
                    segmentsData = null;
                    expectedTotal = 0;
                } catch (error) {
                    console.error('è§£å‹ç¼©å¤±è´¥:', error);
                    document.getElementById('result').textContent = fullData;
                    document.getElementById('result').style.display = 'block';
                    document.getElementById('qr-text').value = fullData;
                }
            }
        }

        function decodeQR() {
            const input = document.getElementById('qr-text').value.trim();
            const resultDiv = document.getElementById('result');
            const errorDiv = document.getElementById('error');
            
            if (!input) {
                alert('è¯·è¾“å…¥äºŒç»´ç å†…å®¹');
                return;
            }

            try {
                // å¦‚æœè¾“å…¥ä¸ä»¥ v1ã€v2ã€v3 å¼€å¤´ï¼Œå°è¯•ä½œä¸ºå‹ç¼©æ•°æ®ç›´æ¥è§£å‹
                if (!input.startsWith('v1') && !input.startsWith('v2') && !input.startsWith('v3')) {
                    try {
                        const decompressedText = LZString.decompressFromEncodedURIComponent(input);
                        if (decompressedText) {
                            resultDiv.textContent = decompressedText;
                        } else {
                            resultDiv.textContent = input;
                        }
                        resultDiv.style.display = 'block';
                        errorDiv.style.display = 'none';
                        return;
                    } catch (error) {
                        resultDiv.textContent = input;
                        resultDiv.style.display = 'block';
                        errorDiv.style.display = 'none';
                        return;
                    }
                }

                let decodedText = '';
                console.log('åŸå§‹è¾“å…¥:', input);
                
                const version = input.substring(0, 2);
                console.log('ç‰ˆæœ¬:', version);
                
                const content = input.substring(2);  
                console.log('å†…å®¹:', content);

                if (version === 'v1') {
                    // GZIP æ ¼å¼
                    const base64 = content
                        .replace(/-/g, '+')
                        .replace(/_/g, '/');
                    const binaryString = atob(base64);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    const inflated = pako.inflate(bytes);
                    decodedText = new TextDecoder().decode(inflated);
                } else if (version === 'v2') {
                    // å•æ®µ LZ-string æ ¼å¼
                    decodedText = LZString.decompressFromEncodedURIComponent(content);
                } else if (version === 'v3') {
                    // åˆ†æ®µ LZ-string æ ¼å¼
                    const currentSegment = parseInt(content.substring(0, 2));
                    const totalSegments = parseInt(content.substring(2, 4));
                    const segmentData = content.substring(4);

                    console.log('å½“å‰æ®µå·:', currentSegment);
                    console.log('æ€»æ®µæ•°:', totalSegments);
                    console.log('æ®µæ•°æ®é•¿åº¦:', segmentData.length);

                    // åˆå§‹åŒ–æˆ–é‡ç½®åˆ†æ®µæ•°æ®
                    if (!segmentsData || expectedTotal !== totalSegments) {
                        console.log('åˆå§‹åŒ–åˆ†æ®µæ•°ç»„ï¼Œæ€»æ®µæ•°:', totalSegments);
                        segmentsData = new Array(totalSegments).fill(null);
                        expectedTotal = totalSegments;
                    }

                    // ä¿å­˜å½“å‰åˆ†æ®µ
                    console.log('ä¿å­˜æ®µæ•°æ®åˆ°ç´¢å¼•:', currentSegment - 1);
                    segmentsData[currentSegment - 1] = segmentData;

                    // è¾“å‡ºå½“å‰æ‰€æœ‰æ®µçš„çŠ¶æ€
                    console.log('å½“å‰åˆ†æ®µçŠ¶æ€:', segmentsData.map((seg, i) => seg ? `æ®µ${i + 1}:å·²æ”¶é›†` : `æ®µ${i + 1}:æœªæ”¶é›†`));

                    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰åˆ†æ®µéƒ½å·²æ”¶é›†
                    const missingSegments = segmentsData
                        .map((seg, i) => seg === null ? i + 1 : null)
                        .filter(x => x !== null);

                    if (missingSegments.length > 0) {
                        console.log('ç¼ºå°‘çš„æ®µ:', missingSegments);
                        decodedText = `å·²æ”¶é›† ${totalSegments - missingSegments.length} ä¸ªåˆ†æ®µï¼Œè¿˜ç¼ºå°‘ä»¥ä¸‹åˆ†æ®µï¼š${missingSegments.join(', ')}`;
                    } else {
                        // æ‰€æœ‰åˆ†æ®µéƒ½å·²æ”¶é›†ï¼Œè¿›è¡Œè§£ç 
                        console.log('æ‰€æœ‰åˆ†æ®µå·²æ”¶é›†ï¼Œå¼€å§‹åˆå¹¶');
                        const fullData = segmentsData.join('');
                        console.log('åˆå¹¶åæ•°æ®é•¿åº¦:', fullData.length);
                        decodedText = LZString.decompressFromEncodedURIComponent(fullData);
                        // è§£ç æˆåŠŸåæ¸…ç†æ•°æ®
                        segmentsData = null;
                        expectedTotal = 0;
                    }
                } else {
                    // å°è¯•ä½œä¸ºå‹ç¼©æ•°æ®ç›´æ¥è§£å‹
                    try {
                        decodedText = LZString.decompressFromEncodedURIComponent(input);
                        if (!decodedText) {
                            decodedText = input;
                        }
                    } catch (error) {
                        decodedText = input;
                    }
                }

                resultDiv.textContent = decodedText;
                resultDiv.style.display = 'block';
                errorDiv.style.display = 'none';
            } catch (error) {
                console.error('è§£ç å‡ºé”™:', error);
                errorDiv.textContent = 'è§£ç å¤±è´¥ï¼š' + error.message;
                errorDiv.style.display = 'block';
                resultDiv.style.display = 'none';
            }
        }

        function resetSegments() {
            segmentsData = null;
            expectedTotal = 0;
            processedImages.clear();
            document.getElementById('result').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('qr-text').value = '';
            previewContainer.innerHTML = '';
            alert('å·²é‡ç½®æ‰€æœ‰æ•°æ®');
        }
    </script>
</body>
</html>
